<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dede'nin Gizemli Evi</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&family=Press+Start+2P&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        :root {
            --pixel-size: 4px;
            --bg-dark: #1a1a2e;
            --bg-darker: #0f0f1a;
            --purple: #6b5b95;
            --purple-dark: #4a3f6b;
            --gold: #f4d03f;
            --gold-dark: #c9a227;
            --teal: #45b7aa;
            --pale: #e8e8e8;
            --wood: #8b7355;
            --wood-dark: #5c4d3a;
        }
        
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            touch-action: none;
        }
        
        body {
            font-family: 'VT323', monospace;
            background: var(--bg-darker);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--pale);
            image-rendering: pixelated;
        }
        
        #game-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            height: 100%;
            max-height: 650px;
            background: var(--bg-dark);
            border: 4px solid #2a2a4e;
            box-shadow: 0 0 30px rgba(107,91,149,0.3);
            overflow: hidden;
        }
        
        @media (max-width: 920px) {
            #game-container {
                max-width: 100%;
                max-height: 100%;
                border: none;
                border-radius: 0;
            }
        }
        
        /* ===== INTRO ===== */
        #intro-screen {
            position: absolute;
            inset: 0;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 200;
            padding: 20px;
            text-align: center;
        }
        #intro-screen.hidden { display: none; }
        
        .story-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(16px, 5vw, 24px);
            color: var(--gold);
            text-shadow: 0 0 20px rgba(244,208,63,0.5), 2px 2px 0 #000;
            margin-bottom: 25px;
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 20px rgba(244,208,63,0.5), 2px 2px 0 #000; }
            50% { text-shadow: 0 0 30px rgba(244,208,63,0.8), 2px 2px 0 #000; }
        }
        
        .story-text {
            max-width: 500px;
            font-size: clamp(14px, 4vw, 18px);
            line-height: 1.8;
            color: var(--pale);
            margin-bottom: 25px;
        }
        .story-text .highlight {
            color: var(--gold);
            font-weight: bold;
        }
        
        .continue-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(10px, 3vw, 12px);
            padding: 15px 30px;
            background: linear-gradient(180deg, var(--purple), var(--purple-dark));
            border: 3px solid var(--gold);
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .continue-btn:hover, .continue-btn:active {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(244,208,63,0.5);
        }
        
        /* ===== MENU ===== */
        #menu {
            position: absolute;
            inset: 0;
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background: linear-gradient(180deg, #1a1a2e 0%, #0f0f1a 100%);
            z-index: 100;
            overflow-y: auto;
        }
        #menu.active { display: flex; }
        
        .game-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(12px, 4vw, 18px);
            color: var(--gold);
            text-shadow: 0 0 20px rgba(244,208,63,0.5), 2px 2px 0 #000;
            margin-bottom: 5px;
            text-align: center;
        }
        
        .game-subtitle {
            font-size: clamp(12px, 3vw, 16px);
            color: var(--teal);
            margin-bottom: 20px;
        }
        
        .menu-section {
            margin-bottom: 15px;
            text-align: center;
            width: 100%;
            max-width: 500px;
        }
        
        .section-title {
            font-size: 14px;
            color: #888;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        
        .char-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            justify-content: center;
        }
        
        @media (min-width: 500px) {
            .char-grid { grid-template-columns: repeat(4, 1fr); }
        }
        
        .char-card {
            background: linear-gradient(180deg, #2a2a4e, #1a1a2e);
            border: 3px solid #3a3a5e;
            padding: 12px 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }
        .char-card:hover, .char-card:active {
            border-color: var(--teal);
            transform: translateY(-2px);
        }
        .char-card.selected {
            border-color: var(--gold);
            background: linear-gradient(180deg, #3a3a5e, #2a2a4e);
            box-shadow: 0 0 15px rgba(244,208,63,0.3);
        }
        
        .char-sprite {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .char-name {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--gold);
            margin-bottom: 4px;
        }
        .char-stats {
            font-size: 11px;
            color: #aaa;
        }
        
        .chapter-select {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        .chapter-btn {
            padding: 10px 16px;
            font-family: 'VT323', monospace;
            font-size: 16px;
            background: #2a2a4e;
            border: 2px solid #3a3a5e;
            color: var(--pale);
            cursor: pointer;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .chapter-btn:hover { border-color: var(--teal); }
        .chapter-btn.selected {
            border-color: var(--gold);
            background: #3a3a5e;
            color: var(--gold);
        }
        .chapter-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        
        .start-btn {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(10px, 3vw, 14px);
            padding: 15px 35px;
            background: linear-gradient(180deg, var(--teal), #2a8a7f);
            border: 3px solid var(--gold);
            color: white;
            cursor: pointer;
            margin-top: 15px;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }
        .start-btn:hover:not(:disabled), .start-btn:active:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 0 25px rgba(69,183,170,0.5);
        }
        .start-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #highscore {
            margin-top: 15px;
            color: var(--gold);
            font-size: 14px;
        }
        
        /* ===== GAME ===== */
        #game {
            position: absolute;
            inset: 0;
            display: none;
        }
        #game.active { display: block; }
        
        .hud {
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 50px;
            background: linear-gradient(180deg, #1a1a2e, #0f0f1a);
            border-bottom: 3px solid #3a3a5e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 10px;
            z-index: 50;
            flex-wrap: wrap;
        }
        
        .hud-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .hud-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
        }
        
        .pixel-bar {
            width: 60px;
            height: 10px;
            background: #1a1a1a;
            border: 2px solid #3a3a3a;
            overflow: hidden;
        }
        .pixel-bar-fill {
            height: 100%;
            transition: width 0.3s;
        }
        .health-fill { background: linear-gradient(90deg, #e74c3c, #c0392b); }
        .energy-fill { background: linear-gradient(90deg, var(--teal), #2a8a7f); }
        
        .chapter-indicator {
            font-family: 'Press Start 2P', monospace;
            font-size: 8px;
            color: var(--purple);
        }
        
        .room-name {
            font-size: 16px;
            color: var(--gold);
            display: none;
        }
        @media (min-width: 500px) {
            .room-name { display: block; }
        }
        
        .timer {
            font-family: 'Press Start 2P', monospace;
            font-size: 10px;
            color: var(--pale);
        }
        
        .hud-stat { font-size: 14px; }
        
        .pause-btn {
            background: none;
            border: 2px solid #3a3a5e;
            padding: 5px 10px;
            color: var(--pale);
            cursor: pointer;
            font-size: 16px;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* ===== GAME AREA ===== */
        #game-area {
            position: absolute;
            top: 50px;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
        }
        
        @media (max-width: 600px) {
            #game-area { bottom: 120px; }
        }
        
        #room {
            position: absolute;
            inset: 0;
            image-rendering: pixelated;
        }
        
        /* Room backgrounds - cozy mysterious style */
        .room-salon { 
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(107,91,149,0.1) 0%, transparent 50%),
                linear-gradient(180deg, #2d2d4a 0%, #1a1a30 100%); 
        }
        .room-mutfak { 
            background: 
                radial-gradient(ellipse at 80% 30%, rgba(69,183,170,0.08) 0%, transparent 50%),
                linear-gradient(180deg, #2a3d4a 0%, #1a2530 100%); 
        }
        .room-yatak { 
            background: 
                radial-gradient(ellipse at 50% 50%, rgba(149,91,107,0.1) 0%, transparent 50%),
                linear-gradient(180deg, #3d2d4a 0%, #251a30 100%); 
        }
        .room-bodrum { 
            background: 
                radial-gradient(ellipse at 30% 70%, rgba(80,80,100,0.1) 0%, transparent 50%),
                linear-gradient(180deg, #252535 0%, #151520 100%); 
        }
        
        .room-floor {
            position: absolute;
            bottom: 0; left: 0; right: 0;
            height: 120px;
            background: 
                repeating-linear-gradient(90deg, 
                    #5a4a3a 0px, #5a4a3a 40px,
                    #6a5a4a 40px, #6a5a4a 80px
                );
            border-top: 4px solid #3a2a1a;
            image-rendering: pixelated;
        }
        
        .room-floor::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: 
                repeating-linear-gradient(90deg,
                    transparent 0px,
                    transparent 39px,
                    rgba(0,0,0,0.2) 39px,
                    rgba(0,0,0,0.2) 41px,
                    transparent 41px,
                    transparent 80px
                );
        }
        
        /* Duvar sÃ¼sleri */
        .room-wall-decor {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 40px;
            opacity: 0.15;
            filter: blur(1px);
        }
        
        .furniture {
            position: absolute;
            image-rendering: pixelated;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            border: 3px solid;
            border-color: #7a6a5a #4a3a2a #4a3a2a #7a6a5a;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.4),
                inset 4px 4px 0 rgba(255,255,255,0.15),
                2px 4px 8px rgba(0,0,0,0.3);
            transition: box-shadow 0.3s;
        }
        
        .furniture::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 50%;
            height: 3px;
            background: linear-gradient(90deg, rgba(255,255,255,0.2), transparent);
        }
        
        .furniture.hideable {
            cursor: pointer;
        }
        
        .furniture.hideable:hover {
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.4),
                inset 4px 4px 0 rgba(255,255,255,0.15),
                0 0 20px rgba(69,183,170,0.5),
                2px 4px 8px rgba(0,0,0,0.3);
        }
        
        .door {
            position: absolute;
            background: linear-gradient(180deg, #7a6a5a, #5a4a3a);
            border: 4px solid;
            border-color: #9a8a7a #4a3a2a #4a3a2a #9a8a7a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            z-index: 10;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.3),
                inset 4px 4px 0 rgba(255,255,255,0.1),
                4px 4px 10px rgba(0,0,0,0.4);
        }
        .door::before {
            content: '';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, var(--gold), #aa8800);
            border-radius: 50%;
            box-shadow: 0 0 6px var(--gold);
        }
        .door::after {
            content: '';
            position: absolute;
            top: 10%;
            left: 15%;
            right: 15%;
            bottom: 55%;
            background: rgba(0,0,0,0.2);
            border: 2px solid rgba(0,0,0,0.3);
        }
        .door-label {
            font-size: 8px;
            color: rgba(255,255,255,0.7);
            margin-top: 4px;
            text-shadow: 1px 1px 1px rgba(0,0,0,0.5);
        }
        
        .door.exit {
            background: linear-gradient(180deg, #4a7a5a, #3a5a4a);
            border-color: #6a9a7a #2a4a3a #2a4a3a #6a9a7a;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.3),
                inset 4px 4px 0 rgba(255,255,255,0.1),
                0 0 15px rgba(69,183,170,0.3),
                4px 4px 10px rgba(0,0,0,0.4);
        }
        .door.exit.locked {
            background: linear-gradient(180deg, #6a5050, #4a3535);
            border-color: #8a7070 #3a2525 #3a2525 #8a7070;
            box-shadow: 
                inset -4px -4px 0 rgba(0,0,0,0.3),
                inset 4px 4px 0 rgba(255,255,255,0.1),
                4px 4px 10px rgba(0,0,0,0.4);
        }
        .door.exit.locked::after {
            content: 'ğŸ”’';
            position: absolute;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: none;
            border: none;
        }
        
        .puzzle-obj {
            position: absolute;
            font-size: 28px;
            z-index: 15;
            filter: drop-shadow(0 0 8px rgba(244,208,63,0.5));
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-6px); }
        }
        
        .clue-obj {
            position: absolute;
            font-size: 24px;
            z-index: 15;
            filter: drop-shadow(0 0 6px rgba(69,183,170,0.6));
            animation: float 2.5s ease-in-out infinite;
        }
        
        .player {
            position: absolute;
            width: 32px;
            height: 48px;
            z-index: 40;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px;
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.5));
            transition: opacity 0.2s, transform 0.1s;
        }
        .player.hiding { 
            opacity: 0.3; 
            transform: scale(0.9);
        }
        .player.hurt { 
            animation: hurtBlink 0.12s linear 4; 
        }
        
        @keyframes hurtBlink {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.3; transform: scale(1.1); filter: brightness(1.8) drop-shadow(0 0 10px #ff6666); }
        }
        
        .grandpa {
            position: absolute;
            width: 40px;
            height: 56px;
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            z-index: 35;
            filter: drop-shadow(2px 3px 2px rgba(0,0,0,0.5));
            transition: filter 0.3s;
        }
        .grandpa.visible { display: flex; }
        .grandpa.chasing {
            animation: grandpaChase 0.2s infinite;
            filter: 
                drop-shadow(2px 3px 2px rgba(0,0,0,0.5))
                drop-shadow(0 0 12px rgba(107,91,149,0.7));
        }
        
        @keyframes grandpaChase {
            0%, 100% { transform: translateY(0) rotate(-2deg); }
            50% { transform: translateY(-4px) rotate(2deg); }
        }
        
        .msg {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15,15,26,0.95);
            border: 2px solid var(--purple);
            padding: 10px 20px;
            font-size: 14px;
            display: none;
            z-index: 60;
            max-width: 90%;
            text-align: center;
        }
        .msg.show { display: block; animation: msgPop 0.3s; }
        
        @keyframes msgPop {
            from { opacity: 0; transform: translateX(-50%) scale(0.9); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }
        
        .minimap {
            position: absolute;
            bottom: 10px;
            right: 10px;
            width: 80px;
            height: 65px;
            background: rgba(15,15,26,0.9);
            border: 2px solid #3a3a5e;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: 1fr 1fr;
            gap: 2px;
            padding: 3px;
            z-index: 50;
        }
        
        @media (max-width: 400px) {
            .minimap { display: none; }
        }
        
        .map-room {
            background: #2a2a4e;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 7px;
            color: #666;
        }
        .map-room.current {
            background: var(--purple-dark);
            color: white;
        }
        .map-room.has-grandpa::after {
            content: 'ğŸ‘€';
            font-size: 8px;
        }
        
        .controls-hint {
            position: absolute;
            bottom: 8px;
            left: 10px;
            font-size: 10px;
            color: #444;
        }
        
        @media (max-width: 600px) {
            .controls-hint { display: none; }
        }
        
        #fog {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 45;
            background: radial-gradient(ellipse at center, transparent 40%, rgba(15,15,26,0.3) 100%);
        }
        
        /* ===== MOBILE CONTROLS ===== */
        #mobile-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 130px;
            background: linear-gradient(180deg, rgba(26,26,46,0.95), rgba(15,15,26,0.98));
            border-top: 3px solid #3a3a5e;
            display: none;
            justify-content: space-between;
            align-items: center;
            padding: 10px 25px;
            z-index: 80;
        }
        
        @media (max-width: 768px), (pointer: coarse) {
            #mobile-controls { display: flex; }
            #game-area { bottom: 130px; }
            .controls-hint { display: none; }
            .minimap { 
                width: 70px; 
                height: 55px; 
                bottom: 5px;
                right: 5px;
            }
            .map-room { font-size: 6px; }
        }
        
        @media (max-width: 480px) {
            #mobile-controls { 
                height: 120px;
                padding: 8px 15px;
            }
            #game-area { bottom: 120px; }
            .hud { 
                height: 45px; 
                padding: 0 8px;
            }
            .hud-item { gap: 3px; }
            .pixel-bar { width: 50px; height: 8px; }
            .timer { font-size: 9px; }
            .chapter-indicator { font-size: 7px; }
        }
        
        #joystick-zone {
            width: 110px;
            height: 110px;
            background: rgba(58,58,94,0.6);
            border: 3px solid #5a5a7e;
            border-radius: 50%;
            position: relative;
            touch-action: none;
            flex-shrink: 0;
        }
        
        #joystick-knob {
            width: 50px;
            height: 50px;
            background: linear-gradient(145deg, var(--teal), #2a8a7f);
            border: 3px solid var(--gold);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .mobile-btns {
            display: flex;
            gap: 15px;
            flex-shrink: 0;
        }
        
        .mobile-btn {
            width: 65px;
            height: 65px;
            border-radius: 50%;
            border: 3px solid;
            font-size: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
            user-select: none;
            transition: transform 0.1s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .mobile-btn:active {
            transform: scale(0.9);
        }
        
        #btn-action {
            background: linear-gradient(145deg, var(--purple), var(--purple-dark));
            border-color: var(--gold);
        }
        
        #btn-run {
            background: linear-gradient(145deg, var(--teal), #2a8a7f);
            border-color: var(--gold);
        }
        
        @media (max-width: 480px) {
            #joystick-zone {
                width: 95px;
                height: 95px;
            }
            #joystick-knob {
                width: 42px;
                height: 42px;
            }
            .mobile-btn {
                width: 55px;
                height: 55px;
                font-size: 22px;
            }
            .mobile-btns { gap: 10px; }
        }
        
        /* ===== MODALS ===== */
        .modal {
            position: absolute;
            inset: 0;
            display: none;
            justify-content: center;
            align-items: center;
            background: rgba(0,0,0,0.9);
            z-index: 500;
            padding: 15px;
        }
        .modal.active { display: flex; }
        
        .modal-box {
            background: linear-gradient(180deg, #2a2a4e, #1a1a2e);
            border: 3px solid var(--purple);
            padding: 25px;
            text-align: center;
            max-width: 95%;
            max-height: 90%;
            overflow-y: auto;
        }
        
        .modal-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(10px, 3vw, 14px);
            color: var(--gold);
            margin-bottom: 15px;
        }
        
        .modal-text {
            font-size: 16px;
            line-height: 1.6;
            margin-bottom: 15px;
            color: var(--pale);
        }
        
        .modal-input {
            width: 100%;
            max-width: 200px;
            padding: 14px;
            font-family: 'VT323', monospace;
            font-size: 24px;
            text-align: center;
            background: #0f0f1a;
            border: 2px solid #3a3a5e;
            color: var(--gold);
            margin-bottom: 12px;
            border-radius: 4px;
            -webkit-appearance: none;
            appearance: none;
        }
        .modal-input:focus {
            outline: none;
            border-color: var(--teal);
            box-shadow: 0 0 10px rgba(69,183,170,0.3);
        }
        
        /* Mobil iÃ§in input ayarlarÄ± */
        @media (max-width: 480px) {
            .modal-input {
                font-size: 20px;
                padding: 12px;
                max-width: 180px;
            }
            .modal-box {
                padding: 20px 15px;
                max-width: 92%;
            }
            .modal-title {
                font-size: 11px;
            }
            .modal-text {
                font-size: 15px;
            }
            .btn {
                font-size: 15px;
                padding: 10px 16px;
            }
            .modal-btns {
                gap: 8px;
            }
        }
        
        .modal-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .btn {
            font-family: 'VT323', monospace;
            font-size: 16px;
            padding: 10px 20px;
            border: 2px solid;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
        }
        
        .btn-teal {
            background: linear-gradient(180deg, var(--teal), #2a8a7f);
            border-color: var(--gold);
            color: white;
        }
        .btn-purple {
            background: linear-gradient(180deg, var(--purple), var(--purple-dark));
            border-color: var(--gold);
            color: white;
        }
        .btn-gray {
            background: linear-gradient(180deg, #444, #2a2a2a);
            border-color: #666;
            color: #aaa;
        }
        
        .feedback {
            font-size: 16px;
            margin: 8px 0;
            min-height: 20px;
        }
        .feedback.correct { color: var(--teal); }
        .feedback.wrong { color: #e74c3c; }
        
        .hint {
            font-size: 14px;
            color: var(--gold);
            margin: 8px 0;
        }
        
        .hiding-modal .modal-box { border-color: var(--teal); }
        .hiding-text {
            font-size: 22px;
            color: var(--teal);
            margin-bottom: 15px;
        }
        .peephole {
            width: 100px;
            height: 100px;
            margin: 0 auto 15px;
            background: radial-gradient(circle, #1a1a2e 0%, #000 70%);
            border: 3px solid #3a3a5e;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 13px;
        }
        .hide-warning {
            color: #e74c3c;
            font-size: 16px;
            margin-top: 10px;
            display: none;
        }
        .hide-warning.show { display: block; animation: pulse 0.5s infinite; }
        
        @keyframes pulse {
            50% { opacity: 0.5; }
        }
        
        #chapter-transition {
            position: absolute;
            inset: 0;
            background: #000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 600;
            padding: 20px;
            text-align: center;
        }
        #chapter-transition.active { display: flex; }
        
        .chapter-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(12px, 4vw, 18px);
            color: var(--gold);
            margin-bottom: 15px;
        }
        .chapter-subtitle {
            font-size: 18px;
            color: var(--pale);
        }
        
        .win-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(14px, 4vw, 20px);
            color: var(--teal);
            margin-bottom: 15px;
        }
        .lose-title {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(14px, 4vw, 20px);
            color: #e74c3c;
            margin-bottom: 15px;
        }
        .score {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(12px, 3vw, 16px);
            color: var(--gold);
            margin: 15px 0;
        }
        
        .safe-display {
            font-family: 'Press Start 2P', monospace;
            font-size: clamp(18px, 5vw, 24px);
            color: var(--teal);
            background: #0f0f1a;
            padding: 12px 25px;
            margin-bottom: 15px;
            border: 3px solid #3a3a5e;
            letter-spacing: 8px;
        }
        
        .clue-list {
            text-align: left;
            margin: 12px 0;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 1px solid #3a3a5e;
        }
        .clue-item {
            margin: 6px 0;
            font-size: 14px;
        }
        .clue-item.found { color: var(--gold); }
        .clue-item.missing { color: #666; }
    </style>
</head>
<body>
    <div id="game-container">
        <!-- INTRO -->
        <div id="intro-screen">
            <h1 class="story-title">ğŸ  DEDENÄ°N GÄ°ZEMLÄ° EVÄ°</h1>
            <div class="story-text">
                <p>YÄ±llardÄ±r kapalÄ± olan <span class="highlight">aile malikÃ¢nesi</span>ne hoÅŸ geldin!</p>
                <br>
                <p>Deden <span class="highlight">Necmi</span> burada yaÅŸardÄ±. Åimdi ev sana miras kaldÄ± ama iÃ§eri girince kapÄ± arkandan kapandÄ±!</p>
                <br>
                <p>Dede biraz <span class="highlight">yaramaz</span> bir ruh... Evde saklambaÃ§ oynamak istiyor!</p>
                <br>
                <p>BulmacalarÄ± Ã§Ã¶z, kasanÄ±n ÅŸifresini bul, anahtarÄ± al ve evden Ã§Ä±k!</p>
                <br>
                <p style="font-size:14px;color:#888;">ğŸ§© 3 bulmaca Ã§Ã¶z â†’ ğŸ” KasayÄ± aÃ§ â†’ ğŸ”‘ AnahtarÄ± al â†’ ğŸšª KaÃ§!</p>
            </div>
            <button class="continue-btn" id="continue-intro">MACERAYA BAÅLA</button>
        </div>
        
        <!-- MENU -->
        <div id="menu">
            <h1 class="game-title">ğŸ  DEDENÄ°N GÄ°ZEMLÄ° EVÄ°</h1>
            <p class="game-subtitle">âœ¨ Bulmaca & KaÃ§Ä±ÅŸ MacerasÄ± âœ¨</p>
            
            <div class="menu-section">
                <div class="section-title">Karakterini SeÃ§</div>
                <div class="char-grid" id="char-grid"></div>
            </div>
            
            <div class="menu-section">
                <div class="section-title">BÃ¶lÃ¼m</div>
                <div class="chapter-select" id="chapter-select"></div>
            </div>
            
            <button class="start-btn" id="start-btn" disabled>ğŸ® OYUNA BAÅLA</button>
            <div id="highscore"></div>
        </div>
        
        <!-- GAME -->
        <div id="game">
            <div class="hud">
                <div class="hud-group">
                    <div class="hud-item">â¤ï¸<div class="pixel-bar"><div class="pixel-bar-fill health-fill" id="health-bar" style="width:100%"></div></div></div>
                    <div class="hud-item">âš¡<div class="pixel-bar"><div class="pixel-bar-fill energy-fill" id="energy-bar" style="width:100%"></div></div></div>
                </div>
                <div class="hud-group">
                    <span class="chapter-indicator" id="chapter-ind">BÃ–LÃœM 1</span>
                    <span class="room-name" id="room-name">SALON</span>
                </div>
                <div class="hud-group">
                    <span class="hud-stat">ğŸ“œ <span id="clue-count">0</span>/3</span>
                    <span class="hud-stat" id="key-indicator">ğŸ”‘âŒ</span>
                    <span class="timer" id="timer">00:00</span>
                    <button class="pause-btn" id="pause-btn">â¸ï¸</button>
                </div>
            </div>
            
            <div id="game-area">
                <div id="room"></div>
                <div id="fog"></div>
                <div class="player" id="player">ğŸ§‘</div>
                <div class="grandpa" id="grandpa">ğŸ‘´</div>
                <div class="msg" id="msg"></div>
                <div class="minimap" id="minimap"></div>
                <div class="controls-hint">WASD: Hareket | E: EtkileÅŸim | SHIFT: KoÅŸ</div>
            </div>
            
            <div id="mobile-controls">
                <div id="joystick-zone">
                    <div id="joystick-knob"></div>
                </div>
                <div class="mobile-btns">
                    <button class="mobile-btn" id="btn-action">ğŸ”</button>
                    <button class="mobile-btn" id="btn-run">ğŸƒ</button>
                </div>
            </div>
        </div>
        
        <!-- MODALS -->
        <div class="modal" id="puzzle-modal">
            <div class="modal-box">
                <div class="modal-title">ğŸ§© BULMACA</div>
                <div class="modal-text" id="puz-text"></div>
                <input type="text" class="modal-input" id="puz-input" placeholder="?" autocomplete="off">
                <div class="feedback" id="puz-feedback"></div>
                <div class="hint" id="puz-hint"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="puz-submit">CEVAPLA</button>
                    <button class="btn btn-gray" id="puz-hint-btn">ğŸ’¡ Ä°PUCU</button>
                    <button class="btn btn-gray" id="puz-close">KAPAT</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="safe-modal">
            <div class="modal-box">
                <div class="modal-title">ğŸ” GÄ°ZEMLÄ° KASA</div>
                <div class="safe-display" id="safe-display">_ _ _</div>
                <div class="clue-list" id="clue-list"></div>
                <input type="text" class="modal-input" id="safe-input" placeholder="3 haneli ÅŸifre" maxlength="3" autocomplete="off">
                <div class="feedback" id="safe-feedback"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="safe-submit">ÅÄ°FREYÄ° GÄ°R</button>
                    <button class="btn btn-gray" id="safe-close">KAPAT</button>
                </div>
            </div>
        </div>
        
        <div class="modal hiding-modal" id="hide-modal">
            <div class="modal-box">
                <div class="hiding-text">ğŸ¤« SaklanÄ±yorsun...</div>
                <div class="peephole" id="peephole">âœ“ GÃ¼vende</div>
                <p style="color:#666;font-size:13px;margin-bottom:15px;">Ã‡Ä±kmak iÃ§in E veya butona bas</p>
                <button class="btn btn-purple" id="exit-hide-btn">ğŸšª Ã‡IKIÅ</button>
                <div class="hide-warning" id="hide-warning">âš ï¸ Dede yaklaÅŸÄ±yor!</div>
            </div>
        </div>
        
        <div class="modal" id="pause-modal">
            <div class="modal-box">
                <div class="modal-title">â¸ï¸ DURAKLATILDI</div>
                <div id="pause-stats" style="margin:15px 0;color:#888;"></div>
                <div class="modal-btns" style="flex-direction:column;gap:10px;">
                    <button class="btn btn-teal" id="resume-btn">â–¶ï¸ DEVAM</button>
                    <button class="btn btn-gray" id="restart-btn">ğŸ”„ YENÄ°DEN</button>
                    <button class="btn btn-purple" id="quit-btn">ğŸ  MENÃœ</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="gameover-modal">
            <div class="modal-box">
                <h2 class="lose-title">ğŸ˜… YAKALANDIN!</h2>
                <p class="modal-text">Dede seni yakaladÄ±!<br>Ama merak etme, tekrar deneyebilirsin.</p>
                <div id="lose-stats" style="margin:15px 0;color:#888;"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="retry-btn">ğŸ”„ TEKRAR DENE</button>
                    <button class="btn btn-gray" id="menu-btn1">ğŸ  MENÃœ</button>
                </div>
            </div>
        </div>
        
        <div class="modal" id="win-modal">
            <div class="modal-box">
                <h2 class="win-title">ğŸ‰ BAÅARDIN!</h2>
                <p class="modal-text" id="win-text"></p>
                <div id="win-stats" style="margin:15px 0;"></div>
                <div class="score" id="win-score"></div>
                <div class="modal-btns">
                    <button class="btn btn-teal" id="next-chapter-btn">SONRAKÄ° BÃ–LÃœM</button>
                    <button class="btn btn-gray" id="menu-btn2">ğŸ  MENÃœ</button>
                </div>
            </div>
        </div>
        
        <div id="chapter-transition">
            <div class="chapter-title" id="trans-title"></div>
            <div class="chapter-subtitle" id="trans-subtitle"></div>
        </div>
    </div>

<script>
// ==================== VERÄ°LER ====================
const CHARS = {
    mehmet: { name: 'MEHMET', emoji: 'ğŸ‘¦', hp: 100, spd: 3.0, stealth: 0.5, desc: 'Dengeli' },
    gulten: { name: 'GÃœLTEN', emoji: 'ğŸ‘§', hp: 80, spd: 3.5, stealth: 0.7, desc: 'HÄ±zlÄ±' },
    feyzullah: { name: 'FEYZULLAH', emoji: 'ğŸ§”', hp: 150, spd: 2.0, stealth: 0.3, desc: 'GÃ¼Ã§lÃ¼' },
    minnos: { name: 'MÄ°NNOÅ', emoji: 'ğŸ±', hp: 50, spd: 4.0, stealth: 0.9, desc: 'Gizli' }
};

const CHAPTERS = [
    { 
        id: 1, 
        name: 'BÃ–LÃœM 1', 
        subtitle: 'TanÄ±ÅŸma',
        story: 'Dedenin evine hoÅŸ geldin! Dede seninle oynamak istiyor...',
        grandpaSpeed: 1.0,
        damageMultiplier: 0.7
    },
    { 
        id: 2, 
        name: 'BÃ–LÃœM 2', 
        subtitle: 'KeÅŸif',
        story: 'Dede biraz daha hÄ±zlandÄ±! Dikkatli ol...',
        grandpaSpeed: 1.25,
        damageMultiplier: 0.85
    },
    { 
        id: 3, 
        name: 'BÃ–LÃœM 3', 
        subtitle: 'Final',
        story: 'Son bÃ¶lÃ¼m! Dede Ã§ok heyecanlÄ±...',
        grandpaSpeed: 1.5,
        damageMultiplier: 1.0
    }
];

const PUZZLE_POOL = [
    // === MATEMATÄ°K - KOLAY ===
    { q: 'Bir dÃ¼zinede kaÃ§ tane vardÄ±r?', a: '12', h: '12 tane = 1 dÃ¼zine' },
    { q: '7 x 8 = ?', a: '56', h: '7 x 8' },
    { q: '9 x 9 = ?', a: '81', h: '9 kare' },
    { q: '6 x 7 = ?', a: '42', h: '6 x 7' },
    { q: '8 x 8 = ?', a: '64', h: '8 kare' },
    { q: '12 x 12 = ?', a: '144', h: '12 kare' },
    { q: '15 + 27 = ?', a: '42', h: 'Topla!' },
    { q: '100 - 37 = ?', a: '63', h: 'Ã‡Ä±kar!' },
    { q: '25 x 4 = ?', a: '100', h: '25 x 4' },
    { q: '144 Ã· 12 = ?', a: '12', h: '144 bÃ¶lÃ¼ 12' },
    { q: '81 Ã· 9 = ?', a: '9', h: '81 bÃ¶lÃ¼ 9' },
    { q: 'âˆš49 = ?', a: '7', h: '49\'un karekÃ¶kÃ¼' },
    { q: 'âˆš64 = ?', a: '8', h: '64\'Ã¼n karekÃ¶kÃ¼' },
    { q: 'âˆš100 = ?', a: '10', h: '100\'Ã¼n karekÃ¶kÃ¼' },
    { q: '5 x 5 = ?', a: '25', h: '5 kare' },
    { q: '11 + 11 = ?', a: '22', h: 'Kolay toplama!' },
    { q: '50 + 50 = ?', a: '100', h: 'YarÄ±m + yarÄ±m' },
    { q: '33 + 33 = ?', a: '66', h: 'Ä°kizler toplamÄ±' },
    { q: '99 - 33 = ?', a: '66', h: 'Ã‡Ä±karma iÅŸlemi' },
    { q: '17 + 8 = ?', a: '25', h: 'Toplama' },
    
    // === GENEL KÃœLTÃœR ===
    { q: 'Bir yÄ±lda kaÃ§ ay var?', a: '12', h: 'Ocak\'tan AralÄ±k\'a' },
    { q: 'Bir haftada kaÃ§ gÃ¼n var?', a: '7', h: 'Pazartesi\'den Pazar\'a' },
    { q: 'Bir gÃ¼nde kaÃ§ saat var?', a: '24', h: 'Gece + gÃ¼ndÃ¼z' },
    { q: 'Bir saatte kaÃ§ dakika var?', a: '60', h: '60 dakika' },
    { q: 'Bir dakikada kaÃ§ saniye var?', a: '60', h: '60 saniye' },
    { q: 'GÃ¶kkuÅŸaÄŸÄ±nda kaÃ§ renk var?', a: '7', h: 'KÄ±rmÄ±zÄ±dan mora' },
    { q: 'TÃ¼rk bayraÄŸÄ±nda kaÃ§ renk var?', a: '2', h: 'KÄ±rmÄ±zÄ± ve beyaz' },
    { q: 'Futbol takÄ±mÄ±nda kaÃ§ oyuncu var?', a: '11', h: 'Sahada oynayan' },
    { q: 'Basketbol takÄ±mÄ±nda kaÃ§ oyuncu var?', a: '5', h: 'Sahada oynayan' },
    { q: 'Voleybol takÄ±mÄ±nda kaÃ§ oyuncu var?', a: '6', h: 'Sahada oynayan' },
    { q: 'Ä°nsan vÃ¼cudunda kaÃ§ duyu var?', a: '5', h: 'GÃ¶rme, iÅŸitme...' },
    { q: 'Bir elde kaÃ§ parmak var?', a: '5', h: 'Say bakalÄ±m' },
    { q: 'Ä°ki elde kaÃ§ parmak var?', a: '10', h: '5 + 5' },
    { q: 'ÃœÃ§genin kaÃ§ kenarÄ± var?', a: '3', h: 'ÃœÃ§-gen' },
    { q: 'Karenin kaÃ§ kenarÄ± var?', a: '4', h: 'DÃ¶rtgen' },
    { q: 'AltÄ±genin kaÃ§ kenarÄ± var?', a: '6', h: 'AltÄ±-gen' },
    
    // === BÄ°LMECELER ===
    { q: 'GÃ¼ndÃ¼z uyur, gece uyanÄ±r?', a: 'baykuÅŸ', h: 'Bir kuÅŸ tÃ¼rÃ¼' },
    { q: 'Ne kadar atsan da geri gelir?', a: 'bumerang', h: 'Avustralya!' },
    { q: 'Dili var konuÅŸmaz?', a: 'terazi', h: 'Ã–lÃ§Ã¼ aleti' },
    { q: 'AyaÄŸÄ± var yÃ¼rÃ¼mez?', a: 'masa', h: 'Mobilya' },
    { q: 'Her gÃ¼n doÄŸar ama canlÄ± deÄŸil?', a: 'gÃ¼neÅŸ', h: 'GÃ¶kyÃ¼zÃ¼nde' },
    { q: 'KanadÄ± var uÃ§maz?', a: 'penguen', h: 'Kutup hayvanÄ±' },
    { q: 'Boynuzu var sÃ¼smez?', a: 'ay', h: 'GÃ¶kyÃ¼zÃ¼nde' },
    { q: 'KuyruÄŸu var hayvan deÄŸil?', a: 'uÃ§ak', h: 'GÃ¶kyÃ¼zÃ¼nde uÃ§ar' },
    { q: 'GÃ¶zÃ¼ var gÃ¶rmez?', a: 'iÄŸne', h: 'DikiÅŸ aleti' },
    { q: 'AÄŸzÄ± var konuÅŸmaz?', a: 'bardak', h: 'Ä°Ã§ine su koyarsÄ±n' },
    { q: 'YÃ¼rÃ¼r ama ayaÄŸÄ± yok?', a: 'saat', h: 'ZamanÄ± gÃ¶sterir' },
    { q: 'Yakar ama ateÅŸ deÄŸil?', a: 'buz', h: 'SoÄŸuk da yakar' },
    { q: 'YeÅŸil atladÄ±, kÄ±rmÄ±zÄ± kapladÄ±?', a: 'karpuz', h: 'Yaz meyvesi' },
    
    // === SAYI DÄ°ZÄ°LERÄ° ===
    { q: '2, 4, 6, 8, ? (Sonraki)', a: '10', h: 'Ã‡ift sayÄ±lar' },
    { q: '1, 3, 5, 7, ? (Sonraki)', a: '9', h: 'Tek sayÄ±lar' },
    { q: '3, 6, 9, 12, ?', a: '15', h: '3\'Ã¼n katlarÄ±' },
    { q: '5, 10, 15, 20, ?', a: '25', h: '5\'in katlarÄ±' },
    { q: '10, 20, 30, 40, ?', a: '50', h: '10\'un katlarÄ±' },
    { q: '1, 4, 9, 16, 25, ?', a: '36', h: 'Kare sayÄ±lar: 6Â²' },
    { q: '1, 1, 2, 3, 5, 8, ?', a: '13', h: 'Fibonacci: Ã¶nceki ikinin toplamÄ±' },
    { q: '2, 4, 8, 16, ?', a: '32', h: 'Ä°kinin katlarÄ±' },
    { q: '1, 2, 4, 7, 11, ?', a: '16', h: '+1, +2, +3, +4, +5' },
    { q: '100, 90, 80, 70, ?', a: '60', h: '10\'ar azalÄ±yor' },
    
    // === MANTIK ===
    { q: 'ABC\'nin tersi nedir?', a: 'cba', h: 'Harfleri ters Ã§evir' },
    { q: '123\'Ã¼n tersi nedir?', a: '321', h: 'RakamlarÄ± ters Ã§evir' },
    { q: 'Bir yÄ±lÄ±n ilk ayÄ± hangisi? (SayÄ±)', a: '1', h: 'Ocak' },
    { q: 'Bir yÄ±lÄ±n son ayÄ± hangisi? (SayÄ±)', a: '12', h: 'AralÄ±k' },
    { q: 'HaftanÄ±n ortasÄ± hangi gÃ¼n? (SayÄ±)', a: '4', h: 'PerÅŸembe' },
    { q: 'Z\'den Ã¶nceki harf nedir?', a: 'y', h: 'Alfabede Z\'den Ã¶nce' },
    { q: 'B\'den sonraki harf nedir?', a: 'c', h: 'Alfabede B\'den sonra' },
    
    // === HAYVANLAR ===
    { q: 'KÃ¶peÄŸin kaÃ§ bacaÄŸÄ± var?', a: '4', h: 'DÃ¶rt ayaklÄ±' },
    { q: 'Ã–rÃ¼mceÄŸin kaÃ§ bacaÄŸÄ± var?', a: '8', h: 'Sekiz bacaklÄ±' },
    { q: 'KarÄ±ncanÄ±n kaÃ§ bacaÄŸÄ± var?', a: '6', h: 'BÃ¶cekler gibi' },
    { q: 'Ahtapotun kaÃ§ kolu var?', a: '8', h: 'Sekiz kollu' },
    { q: 'Kedinin kaÃ§ canÄ± varmÄ±ÅŸ?', a: '9', h: 'Deyime gÃ¶re' },
    
    // === RENKLER ve ÅEKÄ°LLER ===
    { q: 'KÄ±rmÄ±zÄ± + SarÄ± = ?', a: 'turuncu', h: 'Renk karÄ±ÅŸÄ±mÄ±' },
    { q: 'Mavi + SarÄ± = ?', a: 'yeÅŸil', h: 'Renk karÄ±ÅŸÄ±mÄ±' },
    { q: 'KÄ±rmÄ±zÄ± + Mavi = ?', a: 'mor', h: 'Renk karÄ±ÅŸÄ±mÄ±' },
    { q: 'Siyah + Beyaz = ?', a: 'gri', h: 'Renk karÄ±ÅŸÄ±mÄ±' },
    
    // === MEVSIMLER ve ZAMAN ===
    { q: 'Bir yÄ±lda kaÃ§ mevsim var?', a: '4', h: 'Ä°lkbahar, yaz...' },
    { q: 'Yazdan sonra hangi mevsim gelir?', a: 'sonbahar', h: 'Yapraklar dÃ¶kÃ¼len' },
    { q: 'KÄ±ÅŸtan sonra hangi mevsim gelir?', a: 'ilkbahar', h: 'Ã‡iÃ§ekler aÃ§an' },
    
    // === MÃœZIK ===
    { q: 'Bir oktavda kaÃ§ nota var?', a: '7', h: 'Do, Re, Mi...' },
    { q: 'GitarÄ±n kaÃ§ teli var? (Normal)', a: '6', h: 'Standart gitar' },
    { q: 'KemanÄ±n kaÃ§ teli var?', a: '4', h: 'YaylÄ± Ã§algÄ±' },
    { q: 'Piyanonun kaÃ§ tuÅŸu var?', a: '88', h: 'Standart piyano' }
];

const ROOMS = {
    salon: {
        name: 'SALON', bg: 'room-salon',
        furniture: [
            { x: 20, y: 150, w: 110, h: 50, icon: 'ğŸ›‹ï¸', c: '#6b5344', type: 'kanepe' },
            { x: 20, y: 230, w: 60, h: 50, icon: 'ğŸª‘', c: '#5a4535', type: 'koltuk' },
            { x: 150, y: 100, w: 80, h: 50, icon: 'ğŸ“º', c: '#2a2a3a', type: 'tv' },
            { x: 700, y: 150, w: 70, h: 100, icon: 'ğŸ—„ï¸', c: '#4a3a2a', hide: true, type: 'dolap' },
            { x: 150, y: 420, w: 90, h: 40, icon: 'ğŸª´', c: '#3a4a3a', type: 'saksÄ±' }
        ],
        puzzleSpots: [
            { x: 350, y: 100, icon: 'ğŸ–¼ï¸' },
            { x: 500, y: 100, icon: 'ğŸ“š' }
        ],
        clueSpot: { x: 600, y: 420, icon: 'ğŸ“œ' },
        doors: [
            { x: 770, y: 300, w: 30, h: 80, to: 'mutfak', dir: 'right' },
            { x: 400, y: 60, w: 80, h: 30, to: 'yatak', dir: 'top' }
        ],
        patrol: [{x:200,y:350},{x:500,y:400},{x:650,y:350},{x:400,y:380}]
    },
    mutfak: {
        name: 'MUTFAK', bg: 'room-mutfak',
        furniture: [
            { x: 20, y: 100, w: 60, h: 100, icon: 'ğŸ§Š', c: '#8a9a9a', type: 'buzdolabÄ±' },
            { x: 20, y: 230, w: 100, h: 45, icon: 'ğŸ³', c: '#7a6a5a', type: 'tezgah' },
            { x: 140, y: 230, w: 60, h: 45, icon: 'ğŸš°', c: '#6a7a8a', type: 'lavabo' },
            { x: 150, y: 420, w: 80, h: 40, icon: 'ğŸª‘', c: '#5a4a3a', type: 'masa' },
            { x: 680, y: 380, w: 80, h: 70, icon: 'ğŸ“¦', c: '#5a4a3a', hide: true, type: 'kutu' }
        ],
        puzzleSpots: [
            { x: 500, y: 100, icon: 'ğŸ“–' }
        ],
        clueSpot: { x: 350, y: 420, icon: 'ğŸ“œ' },
        doors: [
            { x: 0, y: 300, w: 30, h: 80, to: 'salon', dir: 'left' },
            { x: 400, y: 60, w: 80, h: 30, to: 'bodrum', dir: 'top' }
        ],
        patrol: [{x:300,y:350},{x:550,y:400},{x:650,y:300},{x:400,y:350}]
    },
    yatak: {
        name: 'YATAK ODASI', bg: 'room-yatak',
        furniture: [
            { x: 20, y: 120, w: 130, h: 70, icon: 'ğŸ›ï¸', c: '#5a4a4a', hide: true, type: 'yatak' },
            { x: 20, y: 220, w: 60, h: 100, icon: 'ğŸšª', c: '#4a3a2a', hide: true, type: 'gardrop' },
            { x: 680, y: 100, w: 60, h: 50, icon: 'ğŸª', c: '#6a7a8a', type: 'ayna' },
            { x: 680, y: 200, w: 80, h: 50, icon: 'ğŸ’»', c: '#3a3a4a', type: 'masa' },
            { x: 200, y: 420, w: 50, h: 40, icon: 'ğŸ§¸', c: '#8a6a5a', type: 'oyuncak' }
        ],
        puzzleSpots: [
            { x: 400, y: 100, icon: 'ğŸ–¼ï¸' }
        ],
        clueSpot: { x: 550, y: 420, icon: 'ğŸ“œ' },
        safeSpot: { x: 680, y: 420 },
        doors: [
            { x: 400, y: 480, w: 80, h: 30, to: 'salon', dir: 'bottom' },
            { x: 770, y: 300, w: 30, h: 80, to: 'bodrum', dir: 'right' }
        ],
        patrol: [{x:250,y:350},{x:500,y:420},{x:650,y:350},{x:400,y:380}]
    },
    bodrum: {
        name: 'BODRUM', bg: 'room-bodrum',
        furniture: [
            { x: 20, y: 120, w: 50, h: 50, icon: 'ğŸ“¦', c: '#4a3a2a', type: 'kutu1' },
            { x: 20, y: 200, w: 50, h: 50, icon: 'ğŸ“¦', c: '#3a2a1a', type: 'kutu2' },
            { x: 20, y: 400, w: 60, h: 50, icon: 'ğŸ› ï¸', c: '#5a5a5a', type: 'alet' },
            { x: 650, y: 350, w: 90, h: 80, icon: 'ğŸ“¦', c: '#5a4a3a', hide: true, type: 'kutu3' },
            { x: 650, y: 200, w: 50, h: 55, icon: 'ğŸ›¢ï¸', c: '#5a4a3a', type: 'varil' },
            { x: 300, y: 120, w: 55, h: 45, icon: 'ğŸ•¯ï¸', c: '#4a4a4a', type: 'raf' }
        ],
        puzzleSpots: [],
        clueSpot: null,
        doors: [
            { x: 400, y: 480, w: 80, h: 30, to: 'mutfak', dir: 'bottom' },
            { x: 0, y: 300, w: 30, h: 80, to: 'yatak', dir: 'left' },
            { x: 720, y: 90, w: 60, h: 50, to: 'exit', dir: 'right', isExit: true }
        ],
        patrol: [{x:200,y:350},{x:450,y:400},{x:550,y:350},{x:350,y:380}]
    }
};

// GiriÅŸ pozisyonlarÄ± - tÃ¼m odalarda ortada, mobilyalardan uzak
const ENTRY = { 
    left: {x: 100, y: 340},   // Soldan girince
    right: {x: 680, y: 340},  // SaÄŸdan girince  
    top: {x: 440, y: 200},    // Ãœstten girince
    bottom: {x: 440, y: 380}  // Alttan girince
};

// ==================== OYUN DURUMU ====================
let G = {
    running: false,
    paused: false,
    chapter: 1,
    room: 'salon',
    char: null,
    hp: 100,
    maxHp: 100,
    energy: 100,
    cluesFound: 0,
    clueAnswers: [],
    hasKey: false,
    hiding: false,
    hideSpot: null,
    invincible: false,
    px: 400, py: 320,
    gx: 100, gy: 300,
    gRoom: 'mutfak',
    gChasing: false,
    gPatrolIdx: 0,
    gRoomDelay: 200,
    startTime: 0,
    currentPuzzle: null,
    roomPuzzles: {},
    roomClues: {},
    safeCode: '',
    completedChapters: [false, false, false]
};

let keys = { w:false, a:false, s:false, d:false, shift:false };
let joystick = { active: false, dx: 0, dy: 0 };
let mobileRun = false;
let msgTimeout = null;
let timerInterval = null;

// ==================== YARDIMCI ====================
const $ = id => document.getElementById(id);
const dist = (x1,y1,x2,y2) => Math.sqrt((x2-x1)**2 + (y2-y1)**2);
const clamp = (v,min,max) => Math.max(min, Math.min(max, v));
const collides = (a,b) => a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y;
const rand = (min,max) => Math.floor(Math.random()*(max-min+1))+min;
const shuffle = arr => [...arr].sort(() => Math.random() - 0.5);
const isMobile = () => window.innerWidth <= 600 || 'ontouchstart' in window;

function showMsg(text, dur=2500) {
    const el = $('msg');
    el.innerHTML = text;
    el.classList.add('show');
    clearTimeout(msgTimeout);
    msgTimeout = setTimeout(() => el.classList.remove('show'), dur);
}

function formatTime(s) {
    return Math.floor(s/60).toString().padStart(2,'0') + ':' + (s%60).toString().padStart(2,'0');
}

// ==================== BULMACA OLUÅTUR ====================
function generatePuzzles() {
    // Her oyunda tamamen rastgele 3 bulmaca seÃ§
    const shuffled = shuffle([...PUZZLE_POOL]);
    const selected = shuffled.slice(0, 3);
    
    // 3 haneli rastgele ÅŸifre oluÅŸtur (her oyunda farklÄ±)
    const code = [
        Math.floor(Math.random() * 9) + 1,  // 1-9
        Math.floor(Math.random() * 10),      // 0-9
        Math.floor(Math.random() * 10)       // 0-9
    ];
    G.safeCode = code.join('');
    
    G.roomPuzzles = {};
    G.roomClues = {};
    G.clueAnswers = [];
    
    // Her odaya bir bulmaca ve ipucu ata
    G.roomPuzzles['salon'] = [{ ...selected[0], digit: code[0], digitPos: 1, solved: false }];
    G.roomClues['salon'] = { found: false, digit: code[0], pos: 1 };
    
    G.roomPuzzles['mutfak'] = [{ ...selected[1], digit: code[1], digitPos: 2, solved: false }];
    G.roomClues['mutfak'] = { found: false, digit: code[1], pos: 2 };
    
    G.roomPuzzles['yatak'] = [{ ...selected[2], digit: code[2], digitPos: 3, solved: false }];
    G.roomClues['yatak'] = { found: false, digit: code[2], pos: 3 };
    
    console.log('Yeni bulmacalar oluÅŸturuldu! Kasa ÅŸifresi:', G.safeCode);
    console.log('Bulmaca 1:', selected[0].q);
    console.log('Bulmaca 2:', selected[1].q);
    console.log('Bulmaca 3:', selected[2].q);
}

// ==================== MENÃœ ====================
function initMenu() {
    const grid = $('char-grid');
    grid.innerHTML = '';
    for (const id in CHARS) {
        const c = CHARS[id];
        const card = document.createElement('div');
        card.className = 'char-card';
        card.dataset.id = id;
        card.innerHTML = `
            <div class="char-sprite">${c.emoji}</div>
            <div class="char-name">${c.name}</div>
            <div class="char-stats">â¤ï¸${c.hp} âš¡${c.spd.toFixed(1)}</div>
        `;
        card.onclick = () => selectChar(id);
        grid.appendChild(card);
    }
    
    const chapterDiv = $('chapter-select');
    chapterDiv.innerHTML = '';
    CHAPTERS.forEach((ch, i) => {
        const btn = document.createElement('button');
        btn.className = 'chapter-btn' + (i === 0 ? ' selected' : '');
        btn.textContent = `${ch.id}. BÃ–LÃœM`;
        btn.disabled = i > 0 && !G.completedChapters[i-1];
        btn.onclick = () => selectChapter(ch.id);
        chapterDiv.appendChild(btn);
    });
    
    loadProgress();
}

function selectChar(id) {
    document.querySelectorAll('.char-card').forEach(c => c.classList.remove('selected'));
    document.querySelector(`[data-id="${id}"]`).classList.add('selected');
    G.char = id;
    $('start-btn').disabled = false;
}

function selectChapter(id) {
    G.chapter = id;
    document.querySelectorAll('.chapter-btn').forEach((b,i) => b.classList.toggle('selected', i === id-1));
}

function loadProgress() {
    try {
        const saved = JSON.parse(localStorage.getItem('dedeEviProgress'));
        if (saved) {
            G.completedChapters = saved.chapters || [false, false, false];
            document.querySelectorAll('.chapter-btn').forEach((btn, i) => {
                btn.disabled = i > 0 && !G.completedChapters[i-1];
            });
            if (saved.highscore) $('highscore').textContent = `ğŸ† En Ä°yi: ${saved.highscore} puan`;
        }
    } catch(e) {}
}

function saveProgress() {
    try {
        const saved = JSON.parse(localStorage.getItem('dedeEviProgress')) || {};
        saved.chapters = G.completedChapters;
        localStorage.setItem('dedeEviProgress', JSON.stringify(saved));
    } catch(e) {}
}

// ==================== OYUN BAÅLAT ====================
function startGame() {
    if (!G.char) return;
    
    const ch = CHAPTERS[G.chapter - 1];
    const c = CHARS[G.char];
    
    G.maxHp = c.hp;
    G.hp = c.hp;
    G.energy = 100;
    G.running = true;
    G.paused = false;
    G.room = 'salon';
    G.px = 400; G.py = 300; // GÃ¼venli baÅŸlangÄ±Ã§ pozisyonu - odanÄ±n ortasÄ±
    G.gx = 100; G.gy = 300;
    G.gRoom = 'mutfak';
    G.gChasing = false;
    G.gPatrolIdx = 0;
    G.gRoomDelay = 200;
    G.cluesFound = 0;
    G.clueAnswers = [];
    G.hasKey = false;
    G.hiding = false;
    G.hideSpot = null;
    G.invincible = false;
    G.startTime = Date.now();
    G.currentPuzzle = null;
    
    generatePuzzles();
    
    $('menu').classList.remove('active');
    $('game').classList.add('active');
    $('player').textContent = c.emoji;
    $('chapter-ind').textContent = `BÃ–LÃœM ${G.chapter}`;
    
    renderRoom();
    updateHUD();
    
    console.log('Game started! Running:', G.running, 'Pos:', G.px, G.py);
    
    showChapterTransition(ch, () => {
        timerInterval = setInterval(updateTimer, 1000);
        requestAnimationFrame(gameLoop);
    });
}

function showChapterTransition(chapter, callback) {
    $('trans-title').textContent = chapter.name;
    $('trans-subtitle').textContent = chapter.story;
    $('chapter-transition').classList.add('active');
    
    setTimeout(() => {
        $('chapter-transition').classList.remove('active');
        showMsg('ğŸ” BulmacalarÄ± Ã§Ã¶z, kasayÄ± aÃ§, kaÃ§!', 3000);
        callback();
    }, 2500);
}

// ==================== ODA RENDER ====================
function renderRoom() {
    const room = ROOMS[G.room];
    const el = $('room');
    el.innerHTML = '';
    el.className = room.bg;
    
    // Zemin
    const floor = document.createElement('div');
    floor.className = 'room-floor';
    el.appendChild(floor);
    
    // Duvar dekorasyonu (arka plan)
    const wallDecor = document.createElement('div');
    wallDecor.className = 'room-wall-decor';
    wallDecor.textContent = G.room === 'salon' ? 'ğŸ–¼ï¸' : G.room === 'mutfak' ? 'ğŸ½ï¸' : G.room === 'yatak' ? 'ğŸŒ™' : 'ğŸ•¯ï¸';
    wallDecor.style.cssText = 'position:absolute;top:60px;left:50%;transform:translateX(-50%);font-size:50px;opacity:0.08;';
    el.appendChild(wallDecor);
    
    // Mobilyalar
    room.furniture.forEach(f => {
        const div = document.createElement('div');
        div.className = 'furniture' + (f.hide ? ' hideable' : '');
        
        // Mobilya tipine gÃ¶re farklÄ± stiller
        let extraStyle = '';
        if (f.icon === 'ğŸ§Š') extraStyle = 'border-radius: 4px 4px 0 0;'; // BuzdolabÄ±
        if (f.icon === 'ğŸ›‹ï¸') extraStyle = 'border-radius: 8px 8px 4px 4px;'; // Kanepe
        if (f.icon === 'ğŸ›ï¸') extraStyle = 'border-radius: 6px;'; // Yatak
        if (f.icon === 'ğŸ“¦') extraStyle = 'border-radius: 2px;'; // Kutu
        
        div.style.cssText = `left:${f.x}px;top:${f.y}px;width:${f.w}px;height:${f.h}px;background:${f.c};${extraStyle}`;
        div.innerHTML = `<span style="filter:drop-shadow(1px 1px 1px rgba(0,0,0,0.3))">${f.icon}</span>`;
        el.appendChild(div);
    });
    
    // Bulmacalar
    if (G.roomPuzzles[G.room]) {
        const spots = room.puzzleSpots;
        G.roomPuzzles[G.room].forEach((p, i) => {
            if (p.solved) return;
            const spot = spots[i] || spots[0];
            const div = document.createElement('div');
            div.className = 'puzzle-obj';
            div.style.cssText = `left:${spot.x}px;top:${spot.y}px;`;
            div.textContent = spot.icon;
            el.appendChild(div);
        });
    }
    
    // Ä°pucu objesi
    if (room.clueSpot && G.roomClues[G.room] && !G.roomClues[G.room].found) {
        const div = document.createElement('div');
        div.className = 'clue-obj';
        div.style.cssText = `left:${room.clueSpot.x}px;top:${room.clueSpot.y}px;`;
        div.textContent = room.clueSpot.icon;
        el.appendChild(div);
    }
    
    // Kasa (yatak odasÄ±)
    if (G.room === 'yatak' && !G.hasKey) {
        const spot = room.safeSpot;
        const div = document.createElement('div');
        div.className = 'puzzle-obj';
        div.style.cssText = `left:${spot.x}px;top:${spot.y}px;font-size:32px;`;
        div.textContent = 'ğŸ”';
        el.appendChild(div);
    }
    
    // KapÄ±lar
    room.doors.forEach(d => {
        const div = document.createElement('div');
        let cls = 'door';
        if (d.isExit) cls += ' exit' + (!G.hasKey ? ' locked' : '');
        div.className = cls;
        div.style.cssText = `left:${d.x}px;top:${d.y}px;width:${d.w}px;height:${d.h}px;`;
        const arrows = {left:'â—€',right:'â–¶',top:'â–²',bottom:'â–¼'};
        if (!d.isExit) {
            div.innerHTML = `<span style="font-size:18px">${arrows[d.dir]}</span><span class="door-label">${ROOMS[d.to]?.name.substring(0,3)||''}</span>`;
        }
        el.appendChild(div);
    });
    
    $('room-name').textContent = room.name;
    updateMinimap();
}

// ==================== HUD ====================
function updateHUD() {
    $('health-bar').style.width = (G.hp / G.maxHp * 100) + '%';
    $('energy-bar').style.width = G.energy + '%';
    $('clue-count').textContent = G.cluesFound;
    $('key-indicator').textContent = G.hasKey ? 'ğŸ”‘âœ“' : 'ğŸ”‘âŒ';
}

function updateTimer() {
    if (!G.running || G.paused) return;
    const s = Math.floor((Date.now() - G.startTime) / 1000);
    $('timer').textContent = formatTime(s);
}

function updateMinimap() {
    const map = $('minimap');
    map.innerHTML = '';
    const layout = [{id:'yatak',name:'YTK'},{id:'bodrum',name:'BOD'},{id:'salon',name:'SAL'},{id:'mutfak',name:'MUT'}];
    layout.forEach(r => {
        const div = document.createElement('div');
        div.className = 'map-room' + (r.id===G.room?' current':'') + (r.id===G.gRoom?' has-grandpa':'');
        div.textContent = r.name;
        map.appendChild(div);
    });
}

// ==================== OYUN DÃ–NGÃœSÃœ ====================
function gameLoop() {
    if (!G.running) return;
    
    const safeModal = $('safe-modal');
    const safeActive = safeModal && safeModal.classList.contains('active');
    
    if (!G.paused && !G.hiding && !G.currentPuzzle && !safeActive) {
        movePlayer();
        moveGrandpa();
        checkCollision();
    }
    
    if (G.hiding) updateHidingView();
    
    $('player').style.left = G.px + 'px';
    $('player').style.top = G.py + 'px';
    $('grandpa').style.left = G.gx + 'px';
    $('grandpa').style.top = G.gy + 'px';
    $('grandpa').classList.toggle('visible', G.gRoom === G.room);
    $('grandpa').classList.toggle('chasing', G.gChasing);
    $('grandpa').textContent = G.gChasing ? 'ğŸƒ' : 'ğŸ‘´';
    
    requestAnimationFrame(gameLoop);
}

let debugCounter = 0;
function movePlayer() {
    const c = CHARS[G.char];
    if (!c) { console.log('No character!'); return; }
    
    const running = (keys.shift || mobileRun) && G.energy > 10;
    let spd = c.spd * (running ? 1.8 : 1);
    
    let dx = 0, dy = 0;
    
    if (joystick.active) {
        dx = joystick.dx * spd;
        dy = joystick.dy * spd;
    } else {
        if (keys.w) dy -= spd;
        if (keys.s) dy += spd;
        if (keys.a) dx -= spd;
        if (keys.d) dx += spd;
        if (dx && dy) { dx *= 0.707; dy *= 0.707; }
    }
    
    // Debug her 60 frame'de bir
    debugCounter++;
    if (debugCounter % 60 === 0) {
        console.log('Keys:', keys.w, keys.a, keys.s, keys.d, '| dx,dy:', dx.toFixed(2), dy.toFixed(2), '| pos:', G.px.toFixed(0), G.py.toFixed(0));
    }
    
    if (dx === 0 && dy === 0) {
        G.energy = Math.min(100, G.energy + 0.2);
        updateHUD();
        return;
    }
    
    if (running) G.energy = Math.max(0, G.energy - 0.4);
    else G.energy = Math.min(100, G.energy + 0.1);
    
    const newX = G.px + dx;
    const newY = G.py + dy;
    
    const room = ROOMS[G.room];
    let canX = true, canY = true;
    for (const f of room.furniture) {
        if (collides({x:newX,y:G.py,w:32,h:48}, {x:f.x,y:f.y,w:f.w,h:f.h})) canX = false;
        if (collides({x:G.px,y:newY,w:32,h:48}, {x:f.x,y:f.y,w:f.w,h:f.h})) canY = false;
    }
    
    if (canX) G.px = clamp(newX, 10, 760);
    if (canY) G.py = clamp(newY, 90, 440);
    
    updateHUD();
}

function moveGrandpa() {
    const ch = CHAPTERS[G.chapter - 1];
    
    if (G.gRoom === G.room && !G.hiding) {
        G.gChasing = true;
        const spd = 1.3 * ch.grandpaSpeed;
        const dx = G.px - G.gx;
        const dy = G.py - G.gy;
        const dst = Math.sqrt(dx*dx + dy*dy);
        if (dst > 5) {
            G.gx += (dx/dst) * spd;
            G.gy += (dy/dst) * spd;
        }
    } else {
        G.gChasing = false;
        const room = ROOMS[G.gRoom];
        const target = room.patrol[G.gPatrolIdx];
        const dx = target.x - G.gx;
        const dy = target.y - G.gy;
        const dst = Math.sqrt(dx*dx + dy*dy);
        const spd = 0.9 * ch.grandpaSpeed;
        if (dst > 5) {
            G.gx += (dx/dst) * spd;
            G.gy += (dy/dst) * spd;
        } else {
            G.gPatrolIdx = (G.gPatrolIdx + 1) % room.patrol.length;
        }
        
        G.gRoomDelay--;
        if (G.gRoomDelay <= 0) {
            if (Math.random() < 0.3) {
                const doors = room.doors.filter(d => !d.isExit);
                if (doors.length) {
                    const door = doors[rand(0, doors.length-1)];
                    G.gRoom = door.to;
                    G.gPatrolIdx = 0;
                    const r = ROOMS[G.gRoom];
                    if (r.patrol.length) { G.gx = r.patrol[0].x; G.gy = r.patrol[0].y; }
                    if (G.gRoom === G.room) showMsg('ğŸ‘€ Dede odana geldi!', 2000);
                }
            }
            G.gRoomDelay = 180 + rand(0, 100);
        }
    }
    
    G.gx = clamp(G.gx, 10, 790);
    G.gy = clamp(G.gy, 80, 450);
    updateMinimap();
}

function checkCollision() {
    if (G.gRoom !== G.room || G.invincible) return;
    
    const d = dist(G.px+14, G.py+21, G.gx+18, G.gy+25);
    if (d < 35) {
        takeDamage(15 * CHAPTERS[G.chapter-1].damageMultiplier);
    }
}

function takeDamage(amt) {
    G.hp -= amt;
    updateHUD();
    
    $('game-area').classList.add('shake');
    $('player').classList.add('hurt');
    setTimeout(() => {
        $('game-area').classList.remove('shake');
        $('player').classList.remove('hurt');
    }, 400);
    
    G.invincible = true;
    setTimeout(() => G.invincible = false, 1500);
    
    if (G.hp <= 0) gameOver();
}

// ==================== ETKÄ°LEÅÄ°M ====================
function interact() {
    if (G.hiding) { exitHide(); return; }
    if (G.currentPuzzle || G.paused) return;
    if ($('safe-modal').classList.contains('active')) return;
    
    const room = ROOMS[G.room];
    const px = G.px + 14, py = G.py + 21;
    
    for (const d of room.doors) {
        if (dist(px, py, d.x + d.w/2, d.y + d.h/2) < 55) {
            useDoor(d);
            return;
        }
    }
    
    if (G.room === 'yatak' && !G.hasKey) {
        const safe = room.safeSpot;
        if (dist(px, py, safe.x + 16, safe.y + 16) < 55) {
            openSafe();
            return;
        }
    }
    
    if (room.clueSpot && G.roomClues[G.room] && !G.roomClues[G.room].found) {
        if (dist(px, py, room.clueSpot.x + 12, room.clueSpot.y + 12) < 55) {
            collectClue();
            return;
        }
    }
    
    if (G.roomPuzzles[G.room]) {
        const spots = room.puzzleSpots;
        for (let i = 0; i < G.roomPuzzles[G.room].length; i++) {
            const p = G.roomPuzzles[G.room][i];
            if (p.solved) continue;
            const spot = spots[i] || spots[0];
            if (dist(px, py, spot.x + 14, spot.y + 14) < 55) {
                openPuzzle(G.room, i);
                return;
            }
        }
    }
    
    for (const f of room.furniture) {
        if (f.hide && dist(px, py, f.x + f.w/2, f.y + f.h/2) < 70) {
            tryHide(f);
            return;
        }
    }
    
    showMsg('YakÄ±nda bir ÅŸey yok...', 1000);
}

function useDoor(door) {
    if (door.isExit) {
        if (G.hasKey) {
            chapterWin();
        } else {
            showMsg('ğŸ”’ KapÄ± kilitli! Kasadan anahtarÄ± al.', 2500);
        }
        return;
    }
    
    G.room = door.to;
    const opp = {left:'right',right:'left',top:'bottom',bottom:'top'};
    const entry = ENTRY[opp[door.dir]];
    G.px = entry.x; G.py = entry.y;
    renderRoom();
    showMsg('ğŸ“ ' + ROOMS[G.room].name, 1200);
}

function collectClue() {
    const clue = G.roomClues[G.room];
    clue.found = true;
    G.cluesFound++;
    G.clueAnswers.push({ pos: clue.pos, digit: clue.digit });
    
    updateHUD();
    renderRoom();
    showMsg(`ğŸ“œ Ä°pucu! Åifrenin ${clue.pos}. rakamÄ±: <b style="color:var(--gold)">${clue.digit}</b>`, 3500);
}

function openPuzzle(roomId, idx) {
    const p = G.roomPuzzles[roomId][idx];
    G.currentPuzzle = { roomId, idx, puzzle: p };
    
    $('puz-text').innerHTML = p.q;
    $('puz-input').value = '';
    $('puz-feedback').textContent = '';
    $('puz-hint').textContent = '';
    $('puzzle-modal').classList.add('active');
    setTimeout(() => $('puz-input').focus(), 100);
}

function submitPuzzle() {
    if (!G.currentPuzzle) return;
    const p = G.currentPuzzle.puzzle;
    
    // TÃ¼rkÃ§e karakterleri normalize et
    const normalize = (str) => {
        return str.trim().toLowerCase()
            .replace(/ÅŸ/g, 's').replace(/ÄŸ/g, 'g').replace(/Ã¼/g, 'u')
            .replace(/Ã¶/g, 'o').replace(/Ã§/g, 'c').replace(/Ä±/g, 'i')
            .replace(/Å/g, 's').replace(/Ä/g, 'g').replace(/Ãœ/g, 'u')
            .replace(/Ã–/g, 'o').replace(/Ã‡/g, 'c').replace(/Ä°/g, 'i');
    };
    
    const userAnswer = normalize($('puz-input').value);
    const correctAnswer = normalize(p.a);
    
    if (userAnswer === correctAnswer) {
        $('puz-feedback').className = 'feedback correct';
        $('puz-feedback').textContent = 'âœ“ DOÄRU!';
        p.solved = true;
        
        showMsg(`âœ¨ Åifrenin ${p.digitPos}. rakamÄ±: <b style="color:var(--gold)">${p.digit}</b>`, 3500);
        G.clueAnswers.push({ pos: p.digitPos, digit: p.digit });
        G.cluesFound++;
        updateHUD();
        
        setTimeout(() => {
            $('puzzle-modal').classList.remove('active');
            G.currentPuzzle = null;
            renderRoom();
        }, 1200);
    } else {
        $('puz-feedback').className = 'feedback wrong';
        $('puz-feedback').textContent = 'âœ— YanlÄ±ÅŸ!';
        $('puz-input').value = '';
    }
}

function showPuzzleHint() {
    if (G.currentPuzzle) $('puz-hint').textContent = 'ğŸ’¡ ' + G.currentPuzzle.puzzle.h;
}

function closePuzzle() {
    $('puzzle-modal').classList.remove('active');
    G.currentPuzzle = null;
}

// ==================== KASA ====================
function openSafe() {
    $('safe-modal').classList.add('active');
    updateSafeDisplay();
    $('safe-input').value = '';
    $('safe-feedback').textContent = '';
    setTimeout(() => $('safe-input').focus(), 100);
}

function updateSafeDisplay() {
    const list = $('clue-list');
    list.innerHTML = '<div style="color:#888;margin-bottom:8px;">BulduÄŸun Ä°puÃ§larÄ±:</div>';
    
    for (let i = 1; i <= 3; i++) {
        const found = G.clueAnswers.find(c => c.pos === i);
        const div = document.createElement('div');
        div.className = 'clue-item ' + (found ? 'found' : 'missing');
        div.textContent = found ? `${i}. rakam: ${found.digit}` : `${i}. rakam: ???`;
        list.appendChild(div);
    }
    
    let display = '';
    for (let i = 1; i <= 3; i++) {
        const found = G.clueAnswers.find(c => c.pos === i);
        display += found ? found.digit : '_';
        if (i < 3) display += ' ';
    }
    $('safe-display').textContent = display;
}

function submitSafe() {
    const input = $('safe-input').value.trim();
    
    if (input === G.safeCode) {
        $('safe-feedback').innerHTML = '<span class="correct">âœ“ Kasa aÃ§Ä±ldÄ±!</span>';
        G.hasKey = true;
        updateHUD();
        showMsg('ğŸ”‘ Anahtar bulundu! Ã‡Ä±kÄ±ÅŸa git!', 3000);
        setTimeout(() => {
            $('safe-modal').classList.remove('active');
            renderRoom();
        }, 1200);
    } else {
        $('safe-feedback').innerHTML = '<span class="wrong">âœ— YanlÄ±ÅŸ ÅŸifre!</span>';
        $('safe-input').value = '';
    }
}

function closeSafe() {
    $('safe-modal').classList.remove('active');
}

// ==================== SAKLANMA ====================
function tryHide(furniture) {
    if (G.hiding || G.currentPuzzle) return;
    
    G.hiding = true;
    G.hideSpot = furniture;
    G.px = furniture.x + furniture.w/2 - 14;
    G.py = furniture.y + furniture.h/2 - 21;
    $('player').classList.add('hiding');
    $('hide-modal').classList.add('active');
    $('hide-warning').classList.remove('show');
}

function exitHide() {
    if (G.hideSpot) {
        G.py = G.hideSpot.y + G.hideSpot.h + 8;
        if (G.py > 440) G.py = G.hideSpot.y - 50;
    }
    
    G.hiding = false;
    G.hideSpot = null;
    $('player').classList.remove('hiding');
    $('hide-modal').classList.remove('active');
    $('hide-warning').classList.remove('show');
    showMsg('Saklanmadan Ã§Ä±ktÄ±n.', 800);
}

function updateHidingView() {
    if (!G.hideSpot) return;
    
    const peep = $('peephole');
    const warn = $('hide-warning');
    
    if (G.gRoom === G.room) {
        const fx = G.hideSpot.x + G.hideSpot.w/2;
        const fy = G.hideSpot.y + G.hideSpot.h/2;
        const d = dist(G.gx+18, G.gy+25, fx, fy);
        
        if (d < 90) {
            peep.textContent = 'ğŸ‘€ Ã‡OK YAKIN!';
            peep.style.color = '#e74c3c';
            warn.classList.add('show');
            
            const chance = 0.003 * CHAPTERS[G.chapter-1].grandpaSpeed * (1 - CHARS[G.char].stealth * 0.8);
            if (Math.random() < chance) {
                exitHide();
                showMsg('ğŸ˜² Dede seni buldu!', 2000);
                takeDamage(25 * CHAPTERS[G.chapter-1].damageMultiplier);
            }
        } else if (d < 180) {
            peep.textContent = 'ğŸ‘€ YaklaÅŸÄ±yor...';
            peep.style.color = '#f39c12';
            warn.classList.remove('show');
        } else {
            peep.textContent = 'ğŸ‘€ Odada...';
            peep.style.color = '#888';
            warn.classList.remove('show');
        }
    } else {
        peep.textContent = 'âœ“ GÃ¼vende';
        peep.style.color = 'var(--teal)';
        warn.classList.remove('show');
    }
}

// ==================== WIN/LOSE ====================
function chapterWin() {
    G.running = false;
    clearInterval(timerInterval);
    
    G.completedChapters[G.chapter - 1] = true;
    saveProgress();
    
    const s = Math.floor((Date.now() - G.startTime) / 1000);
    const score = Math.floor((Math.max(0, 300-s) * 10 + G.hp * 5 + G.energy * 2) * (G.chapter * 0.5 + 0.5));
    
    try {
        const saved = JSON.parse(localStorage.getItem('dedeEviProgress')) || {};
        if (!saved.highscore || score > saved.highscore) {
            saved.highscore = score;
            localStorage.setItem('dedeEviProgress', JSON.stringify(saved));
        }
    } catch(e) {}
    
    if (G.chapter < 3) {
        $('win-text').textContent = `BÃ¶lÃ¼m ${G.chapter} tamamlandÄ±! Maceran devam ediyor...`;
        $('next-chapter-btn').style.display = 'inline-block';
        $('next-chapter-btn').textContent = `BÃ–LÃœM ${G.chapter + 1}`;
    } else {
        $('win-text').innerHTML = `<span style="color:var(--gold)">TÃœM BÃ–LÃœMLER TAMAM!</span><br>Dedenin evinden baÅŸarÄ±yla Ã§Ä±ktÄ±n!`;
        $('next-chapter-btn').style.display = 'none';
    }
    
    $('win-stats').innerHTML = `â±ï¸ ${formatTime(s)} | â¤ï¸ ${Math.round(G.hp)} | âš¡ ${Math.round(G.energy)}`;
    $('win-score').textContent = `ğŸ† ${score} PUAN`;
    $('win-modal').classList.add('active');
}

function gameOver() {
    G.running = false;
    clearInterval(timerInterval);
    
    const s = Math.floor((Date.now() - G.startTime) / 1000);
    $('lose-stats').innerHTML = `â±ï¸ ${formatTime(s)} | ğŸ“œ ${G.cluesFound}/3`;
    $('gameover-modal').classList.add('active');
}

function nextChapter() {
    G.chapter++;
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    startGame();
}

function restart() {
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    startGame();
}

function toMenu() {
    G.running = false;
    clearInterval(timerInterval);
    document.querySelectorAll('.modal').forEach(m => m.classList.remove('active'));
    $('game').classList.remove('active');
    $('menu').classList.add('active');
    initMenu();
}

function togglePause() {
    if (!G.running) return;
    G.paused = !G.paused;
    
    if (G.paused) {
        const s = Math.floor((Date.now() - G.startTime) / 1000);
        $('pause-stats').innerHTML = `â±ï¸ ${formatTime(s)}<br>ğŸ“œ ${G.cluesFound}/3 | ğŸ”‘ ${G.hasKey ? 'âœ“' : 'âœ—'}`;
        $('pause-modal').classList.add('active');
    } else {
        $('pause-modal').classList.remove('active');
    }
}

// ==================== INPUT - KLAVYE ====================
document.addEventListener('keydown', e => {
    if (!e || !e.key) return;
    
    // Input veya textarea aktifse oyun kontrollerini devre dÄ±ÅŸÄ± bÄ±rak
    const active = document.activeElement;
    const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
    
    if (isTyping) {
        // Sadece ESC ve Enter'a izin ver
        if (e.key === 'Escape') {
            e.preventDefault();
            active.blur();
            if (G.currentPuzzle) closePuzzle();
            else if ($('safe-modal').classList.contains('active')) closeSafe();
        }
        return; // DiÄŸer tuÅŸlar input'a gitsin
    }
    
    const k = e.key.toLowerCase();
    
    if (k === 'w' || k === 'arrowup') { keys.w = true; e.preventDefault(); }
    if (k === 's' || k === 'arrowdown') { keys.s = true; e.preventDefault(); }
    if (k === 'a' || k === 'arrowleft') { keys.a = true; e.preventDefault(); }
    if (k === 'd' || k === 'arrowright') { keys.d = true; e.preventDefault(); }
    if (k === 'shift') keys.shift = true;
    
    if (k === 'e' || k === ' ') {
        e.preventDefault();
        interact();
    }
    
    if (k === 'escape') {
        e.preventDefault();
        if (G.hiding) exitHide();
        else if (G.currentPuzzle) closePuzzle();
        else if ($('safe-modal').classList.contains('active')) closeSafe();
        else togglePause();
    }
});

document.addEventListener('keyup', e => {
    if (!e || !e.key) return;
    
    // Input aktifse tuÅŸlarÄ± serbest bÄ±rakma
    const active = document.activeElement;
    const isTyping = active && (active.tagName === 'INPUT' || active.tagName === 'TEXTAREA');
    if (isTyping) return;
    
    const k = e.key.toLowerCase();
    
    if (k === 'w' || k === 'arrowup') keys.w = false;
    if (k === 's' || k === 'arrowdown') keys.s = false;
    if (k === 'a' || k === 'arrowleft') keys.a = false;
    if (k === 'd' || k === 'arrowright') keys.d = false;
    if (k === 'shift') keys.shift = false;
});

// ==================== INPUT - MOBÄ°L ====================
function initMobileControls() {
    const zone = $('joystick-zone');
    const knob = $('joystick-knob');
    
    if (!zone || !knob) return;
    
    let startX, startY, zoneRect;
    
    function handleStart(e) {
        e.preventDefault();
        const touch = e.touches ? e.touches[0] : e;
        zoneRect = zone.getBoundingClientRect();
        startX = zoneRect.left + zoneRect.width / 2;
        startY = zoneRect.top + zoneRect.height / 2;
        joystick.active = true;
    }
    
    function handleMove(e) {
        if (!joystick.active) return;
        e.preventDefault();
        
        const touch = e.touches ? e.touches[0] : e;
        let dx = touch.clientX - startX;
        let dy = touch.clientY - startY;
        
        const maxDist = 40;
        const d = Math.sqrt(dx*dx + dy*dy);
        
        if (d > maxDist) {
            dx = (dx / d) * maxDist;
            dy = (dy / d) * maxDist;
        }
        
        joystick.dx = dx / maxDist;
        joystick.dy = dy / maxDist;
        
        knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
    }
    
    function handleEnd(e) {
        e.preventDefault();
        joystick.active = false;
        joystick.dx = 0;
        joystick.dy = 0;
        knob.style.transform = 'translate(-50%, -50%)';
    }
    
    // Touch events
    zone.addEventListener('touchstart', handleStart, { passive: false });
    zone.addEventListener('touchmove', handleMove, { passive: false });
    zone.addEventListener('touchend', handleEnd, { passive: false });
    zone.addEventListener('touchcancel', handleEnd, { passive: false });
    
    // Mouse events (for testing on desktop)
    zone.addEventListener('mousedown', handleStart);
    document.addEventListener('mousemove', e => { if (joystick.active) handleMove(e); });
    document.addEventListener('mouseup', handleEnd);
    
    // Action button - EtkileÅŸim
    const btnAction = $('btn-action');
    if (btnAction) {
        btnAction.addEventListener('touchstart', e => {
            e.preventDefault();
            interact();
        }, { passive: false });
        btnAction.addEventListener('click', interact);
    }
    
    // Run button - KoÅŸma
    const btnRun = $('btn-run');
    if (btnRun) {
        btnRun.addEventListener('touchstart', e => {
            e.preventDefault();
            mobileRun = true;
            btnRun.style.transform = 'scale(0.9)';
        }, { passive: false });
        
        btnRun.addEventListener('touchend', e => {
            e.preventDefault();
            mobileRun = false;
            btnRun.style.transform = 'scale(1)';
        }, { passive: false });
        
        btnRun.addEventListener('touchcancel', e => {
            mobileRun = false;
            btnRun.style.transform = 'scale(1)';
        }, { passive: false });
    }
    
    // Pause button iÃ§in touch
    const pauseBtn = $('pause-btn');
    if (pauseBtn) {
        pauseBtn.addEventListener('touchstart', e => {
            e.preventDefault();
            togglePause();
        }, { passive: false });
    }
}

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', () => {
    $('continue-intro').onclick = () => {
        $('intro-screen').classList.add('hidden');
        $('menu').classList.add('active');
        initMenu();
    };
    
    $('start-btn').onclick = startGame;
    
    $('puz-submit').onclick = submitPuzzle;
    $('puz-hint-btn').onclick = showPuzzleHint;
    $('puz-close').onclick = closePuzzle;
    $('puz-input').onkeypress = e => { if (e.key === 'Enter') submitPuzzle(); };
    
    $('safe-submit').onclick = submitSafe;
    $('safe-close').onclick = closeSafe;
    $('safe-input').onkeypress = e => { if (e.key === 'Enter') submitSafe(); };
    
    $('exit-hide-btn').onclick = exitHide;
    $('hide-modal').onclick = e => { if (e.target.id === 'hide-modal') exitHide(); };
    
    $('pause-btn').onclick = togglePause;
    $('resume-btn').onclick = () => { G.paused = false; $('pause-modal').classList.remove('active'); };
    $('restart-btn').onclick = restart;
    $('quit-btn').onclick = toMenu;
    
    $('retry-btn').onclick = restart;
    $('menu-btn1').onclick = toMenu;
    
    $('next-chapter-btn').onclick = nextChapter;
    $('menu-btn2').onclick = toMenu;
    
    initMobileControls();
    
    console.log('ğŸ  Dedenin Gizemli Evi yÃ¼klendi!');
});
</script>
</body>
</html>
